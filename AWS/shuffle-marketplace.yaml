AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Shuffle SOAR Platform - Docker Swarm Cluster Deployment
  Deploys a highly available Shuffle cluster on AWS using EC2 instances with Docker Swarm.
  Includes: VPC, Security Groups, EC2 Auto Scaling, NFS shared storage, OpenSearch, and load balancing.
  
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Deployment Configuration"
        Parameters:
          - DeploymentName
          - Environment
      - Label:
          default: "Instance Configuration"
        Parameters:
          - InstanceType
          - NodeCount
          - VolumeSize
          - VolumeType
      - Label:
          default: "Network Configuration"
        Parameters:
          - VpcCIDR
          - SubnetCIDR
          - ExternalAccessCIDRs
          - EnableSSH
          - SSHKeyName
          - SSHAccessCIDRs
    ParameterLabels:
      DeploymentName:
        default: "Deployment Name"
      NodeCount:
        default: "Number of Nodes"
      InstanceType:
        default: "EC2 Instance Type"
      VolumeSize:
        default: "EBS Volume Size (GB)"

Parameters:
  DeploymentName:
    Type: String
    Description: Name for this Shuffle deployment (used for resource naming)
    Default: shuffle-cluster
    AllowedPattern: ^[a-z0-9-]+$
    ConstraintDescription: Must contain only lowercase letters, numbers, and hyphens

  Environment:
    Type: String
    Description: Environment type for this deployment
    Default: production
    AllowedValues:
      - dev
      - staging
      - production

  NodeCount:
    Type: Number
    Description: Total number of EC2 instances in the Shuffle cluster (1-10)
    Default: 1
    MinValue: 1
    MaxValue: 10
    ConstraintDescription: Must be between 1 and 10

  InstanceType:
    Type: String
    Description: EC2 instance type for Shuffle nodes (minimum 2 vCPUs, 8GB RAM recommended)
    Default: t3.large
    AllowedValues:
      - t3.large      # 2 vCPUs, 8GB RAM
      - t3.xlarge     # 4 vCPUs, 16GB RAM
      - t3.2xlarge    # 8 vCPUs, 32GB RAM
      - m5.large      # 2 vCPUs, 8GB RAM
      - m5.xlarge     # 4 vCPUs, 16GB RAM
      - m5.2xlarge    # 8 vCPUs, 32GB RAM
      - m6i.large     # 2 vCPUs, 8GB RAM
      - m6i.xlarge    # 4 vCPUs, 16GB RAM
      - m6i.2xlarge   # 8 vCPUs, 32GB RAM

  VolumeSize:
    Type: Number
    Description: Size of the EBS root volume in GB
    Default: 120
    MinValue: 120
    MaxValue: 1000
    ConstraintDescription: Must be between 120 and 1000 GB

  VolumeType:
    Type: String
    Description: EBS volume type
    Default: gp3
    AllowedValues:
      - gp3  # General Purpose SSD (recommended)
      - gp2  # General Purpose SSD
      - io1  # Provisioned IOPS SSD
      - io2  # Provisioned IOPS SSD

  VpcCIDR:
    Type: String
    Description: CIDR block for the VPC
    Default: 10.224.0.0/16
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: Must be a valid CIDR block (e.g., 10.224.0.0/16)

  SubnetCIDR:
    Type: String
    Description: CIDR block for the subnet (must be within VPC CIDR)
    Default: 10.224.1.0/24
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: Must be a valid CIDR block

  ExternalAccessCIDRs:
    Type: CommaDelimitedList
    Description: Comma-separated list of CIDR blocks allowed to access Shuffle UI (port 3001)
    Default: 0.0.0.0/0

  EnableSSH:
    Type: String
    Description: Enable SSH access to instances
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'

  SSHAccessCIDRs:
    Type: CommaDelimitedList
    Description: Comma-separated list of CIDR blocks allowed SSH access (if enabled)
    Default: 0.0.0.0/0

  SSHKeyName:
    Type: String
    Description: EC2 Key Pair name for SSH access (must exist in your AWS account). Required if EnableSSH is true.
    Default: ''


Conditions:
  EnableSSHAccess: !And
    - !Equals [!Ref EnableSSH, 'true']
    - !Not [!Equals [!Ref SSHKeyName, '']]
  MultiNode: !Not [!Equals [!Ref NodeCount, 1]]

Mappings:
  # Ubuntu 22.04 LTS AMI IDs by region
  RegionMap:
    us-east-1:
      AMI: ami-0c7217cdde317cfec  # Ubuntu 22.04 LTS
    us-east-2:
      AMI: ami-0a695f0d95cefc163
    us-west-1:
      AMI: ami-0ce2cb35386fc22e9
    us-west-2:
      AMI: ami-008fe2fc65df48dac
    eu-west-1:
      AMI: ami-0905a3c97561e0b69
    eu-west-2:
      AMI: ami-0eb260c4d5475b901
    eu-west-3:
      AMI: ami-00983e8a26e4c9bd9
    eu-central-1:
      AMI: ami-0faab6bdbac9486fb
    ap-southeast-1:
      AMI: ami-0df7a207adb9748c7
    ap-southeast-2:
      AMI: ami-0310483fb2b488153
    ap-northeast-1:
      AMI: ami-0d52744d6551d851e
    ap-northeast-2:
      AMI: ami-0c9c942bd7bf113a2
    sa-east-1:
      AMI: ami-0af6e9042ea5a4e3e
    ca-central-1:
      AMI: ami-0a2e7efb4257c0907

Resources:
  # ==================== VPC and Networking ====================
  
  ShuffleVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCIDR
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${DeploymentName}-vpc'
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: Shuffle

  ShuffleInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${DeploymentName}-igw'

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref ShuffleVPC
      InternetGatewayId: !Ref ShuffleInternetGateway

  ShuffleSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ShuffleVPC
      CidrBlock: !Ref SubnetCIDR
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select 
        - 0
        - !GetAZs ''
      Tags:
        - Key: Name
          Value: !Sub '${DeploymentName}-subnet'

  ShuffleRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref ShuffleVPC
      Tags:
        - Key: Name
          Value: !Sub '${DeploymentName}-rt'

  ShuffleRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref ShuffleRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref ShuffleInternetGateway

  SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref ShuffleSubnet
      RouteTableId: !Ref ShuffleRouteTable

  # ==================== Security Groups ====================

  ShuffleInternalSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${DeploymentName}-internal-sg'
      GroupDescription: Internal communication for Shuffle Docker Swarm cluster
      VpcId: !Ref ShuffleVPC
      Tags:
        - Key: Name
          Value: !Sub '${DeploymentName}-internal-sg'

  # Docker Swarm Internal Rules
  SwarmTCPIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: tcp
      FromPort: 2376
      ToPort: 2377
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: Docker Swarm management

  SwarmTCPIngress2:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: tcp
      FromPort: 7946
      ToPort: 7946
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: Docker Swarm node communication

  SwarmUDPIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: udp
      FromPort: 7946
      ToPort: 7946
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: Docker Swarm node communication

  SwarmUDPIngress2:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: udp
      FromPort: 4789
      ToPort: 4789
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: Docker overlay network

  # NFS for shared storage
  NFSTCPIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: tcp
      FromPort: 2049
      ToPort: 2049
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: NFS

  NFSTCPIngress2:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: tcp
      FromPort: 111
      ToPort: 111
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: NFS portmapper

  NFSTCPIngress3:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: tcp
      FromPort: 32769
      ToPort: 32769
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: NFS mountd

  NFSUDPIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: udp
      FromPort: 2049
      ToPort: 2049
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: NFS

  NFSUDPIngress2:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: udp
      FromPort: 111
      ToPort: 111
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: NFS portmapper

  # Internal Shuffle services
  OpenSearchIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: tcp
      FromPort: 9200
      ToPort: 9300
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: OpenSearch

  BackendIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: tcp
      FromPort: 5001
      ToPort: 5002
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: Shuffle backend

  WorkerIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: tcp
      FromPort: 33333
      ToPort: 33336
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: Shuffle workers

  MemcachedIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: tcp
      FromPort: 11211
      ToPort: 11211
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: Memcached

  ShuffleExternalSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${DeploymentName}-external-sg'
      GroupDescription: External access to Shuffle UI
      VpcId: !Ref ShuffleVPC
      Tags:
        - Key: Name
          Value: !Sub '${DeploymentName}-external-sg'

  # External access to Shuffle UI (port 3001)
  ExternalHTTPIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleExternalSG
      IpProtocol: tcp
      FromPort: 3001
      ToPort: 3001
      CidrIp: !Select [0, !Ref ExternalAccessCIDRs]
      Description: Shuffle UI access

  # SSH Security Group (conditional)
  ShuffleSSHSG:
    Type: AWS::EC2::SecurityGroup
    Condition: EnableSSHAccess
    Properties:
      GroupName: !Sub '${DeploymentName}-ssh-sg'
      GroupDescription: SSH access to Shuffle nodes
      VpcId: !Ref ShuffleVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Select [0, !Ref SSHAccessCIDRs]
          Description: SSH access
      Tags:
        - Key: Name
          Value: !Sub '${DeploymentName}-ssh-sg'

  # ==================== IAM Role ====================

  ShuffleInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${DeploymentName}-instance-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: ShuffleEC2Permissions
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ec2:DescribeInstances
                  - ec2:DescribeTags
                  - ec2:DescribeNetworkInterfaces
                  - autoscaling:DescribeAutoScalingGroups
                  - autoscaling:DescribeAutoScalingInstances
                Resource: '*'
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogStreams
                Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/shuffle/*'
              - Effect: Allow
                Action:
                  - ssm:PutParameter
                  - ssm:GetParameter
                  - ssm:DeleteParameter
                Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${DeploymentName}/*'
      Tags:
        - Key: Name
          Value: !Sub '${DeploymentName}-instance-role'

  ShuffleInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub '${DeploymentName}-instance-profile'
      Roles:
        - !Ref ShuffleInstanceRole

  ShuffleLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub '${DeploymentName}-launch-template'
      LaunchTemplateData:
        ImageId: !FindInMap [RegionMap, !Ref 'AWS::Region', AMI]
        InstanceType: !Ref InstanceType
        KeyName: !If [EnableSSHAccess, !Ref SSHKeyName, !Ref 'AWS::NoValue']
        IamInstanceProfile:
          Arn: !GetAtt ShuffleInstanceProfile.Arn
        BlockDeviceMappings:
          - DeviceName: /dev/sda1
            Ebs:
              VolumeSize: !Ref VolumeSize
              VolumeType: !Ref VolumeType
              DeleteOnTermination: true
              Encrypted: true
        NetworkInterfaces:
          - DeviceIndex: 0
            AssociatePublicIpAddress: true
            Groups:
              - !Ref ShuffleInternalSG
              - !Ref ShuffleExternalSG
              - !If [EnableSSHAccess, !Ref ShuffleSSHSG, !Ref 'AWS::NoValue']
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub '${DeploymentName}-node'
              - Key: Environment
                Value: !Ref Environment
              - Key: Application
                Value: Shuffle
              - Key: DeploymentName
                Value: !Ref DeploymentName
        UserData:
          Fn::Base64:
            Fn::Sub:
              - |
                #!/bin/bash
                set -euo pipefail
                exec > >(tee /var/log/shuffle-startup.log) 2>&1
                
                echo "Starting Shuffle node initialization..."
                
                # Configuration from CloudFormation
                export DEPLOYMENT_NAME="${DeploymentName}"
                export TOTAL_NODES="${TotalNodes}"
                export AWS_REGION="${AwsRegion}"
                
                # Get EC2 instance metadata
                get_instance_metadata() {
                  local path="$1"
                  TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600" 2>/dev/null || echo "")
                  if [[ -n "$TOKEN" ]]; then
                    curl -H "X-aws-ec2-metadata-token: $TOKEN" "http://169.254.169.254/latest/meta-data/$path" 2>/dev/null || echo ""
                  else
                    curl "http://169.254.169.254/latest/meta-data/$path" 2>/dev/null || echo ""
                  fi
                }
                
                INSTANCE_ID=$(get_instance_metadata "instance-id")
                LOCAL_IP=$(get_instance_metadata "local-ipv4")
                
                echo "Instance ID: $INSTANCE_ID, IP: $LOCAL_IP"
                
                # Wait for cloud-init and disable unattended-upgrades
                cloud-init status --wait || true
                systemctl stop unattended-upgrades apt-daily apt-daily-upgrade || true
                systemctl disable unattended-upgrades apt-daily apt-daily-upgrade || true
                
                # Wait for dpkg locks
                for i in {1..120}; do
                  if ! fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 && ! fuser /var/lib/apt/lists/lock >/dev/null 2>&1; then
                    break
                  fi
                  sleep 5
                done
                
                # Install dependencies
                APT_OPTS="-o DPkg::Lock::Timeout=600 -o Dpkg::Use-Pty=0"
                apt-get $APT_OPTS update
                apt-get $APT_OPTS install -y ca-certificates curl gnupg lsb-release nfs-common nfs-kernel-server jq netcat-openbsd awscli
                
                # Install Docker
                if ! command -v docker &> /dev/null; then
                  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
                  echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" > /etc/apt/sources.list.d/docker.list
                  apt-get $APT_OPTS update
                  apt-get $APT_OPTS install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
                  systemctl enable docker
                  systemctl start docker
                fi
                
                # Setup directories
                mkdir -p /opt/shuffle/shuffle-database
                chown 1000:1000 /opt/shuffle/shuffle-database
                chmod 755 /opt/shuffle/shuffle-database
                
                # Determine if primary node
                ASG_NAME="${DeploymentName}-asg"
                IS_PRIMARY="false"
                for i in {1..30}; do
                  INSTANCES=$(aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names "$ASG_NAME" --region "$AWS_REGION" --query 'AutoScalingGroups[0].Instances[?HealthStatus==`Healthy`].InstanceId' --output text 2>/dev/null | tr '\t' '\n' | sort || echo "")
                  if [[ -n "$INSTANCES" ]]; then
                    FIRST_INSTANCE=$(echo "$INSTANCES" | head -n1)
                    [[ "$INSTANCE_ID" == "$FIRST_INSTANCE" ]] && IS_PRIMARY="true"
                    break
                  fi
                  sleep 10
                done
                [[ "$TOTAL_NODES" == "1" ]] && IS_PRIMARY="true"
                
                cd /opt/shuffle
                
                # Download config files from GitHub
                REPO_BASE="https://raw.githubusercontent.com/Shuffle/gcp-marketplace/master/GCP"
                curl -fsSL "$REPO_BASE/config/swarm.yaml" -o swarm.yaml
                curl -fsSL "$REPO_BASE/config/deploy.sh" -o deploy.sh
                curl -fsSL "$REPO_BASE/config/setup-nfs-server.sh" -o setup-nfs-server.sh
                curl -fsSL "$REPO_BASE/config/nginx-main.conf" -o nginx-main.conf
                curl -fsSL "$REPO_BASE/config/.env" -o .env
                curl -fsSL "$REPO_BASE/scripts/monitor-db-permissions.sh" -o monitor-db-permissions.sh
                chmod +x deploy.sh setup-nfs-server.sh monitor-db-permissions.sh

                
                if [[ "$IS_PRIMARY" == "true" ]]; then
                  docker swarm init --advertise-addr $LOCAL_IP
                  MANAGER_TOKEN=$(docker swarm join-token manager -q)
                  aws ssm put-parameter --name "/$DEPLOYMENT_NAME/swarm-manager-token" --value "$MANAGER_TOKEN" --type "SecureString" --region "$AWS_REGION" --overwrite || true
                  aws ssm put-parameter --name "/$DEPLOYMENT_NAME/primary-manager-ip" --value "$LOCAL_IP" --type "String" --region "$AWS_REGION" --overwrite || true
                  
                  # Wait for all nodes to join
                  for i in {1..300}; do
                    CURRENT_COUNT=$(docker node ls --format "{{.ID}}" | wc -l)
                    [[ "$CURRENT_COUNT" -eq "$TOTAL_NODES" ]] && break
                    sleep 10
                  done
                  sleep 30
                  bash deploy.sh
                else
                  # Secondary node - join swarm
                  for i in {1..60}; do
                    PRIMARY_IP=$(aws ssm get-parameter --name "/$DEPLOYMENT_NAME/primary-manager-ip" --region "$AWS_REGION" --query 'Parameter.Value' --output text 2>/dev/null || echo "")
                    if [[ -n "$PRIMARY_IP" ]] && nc -z -w5 $PRIMARY_IP 2377 2>/dev/null; then
                      MANAGER_TOKEN=$(aws ssm get-parameter --name "/$DEPLOYMENT_NAME/swarm-manager-token" --region "$AWS_REGION" --query 'Parameter.Value' --output text --with-decryption 2>/dev/null || echo "")
                      if [[ -n "$MANAGER_TOKEN" ]]; then
                        docker swarm join --token "$MANAGER_TOKEN" "$PRIMARY_IP:2377" && break
                      fi
                    fi
                    sleep 10
                  done
                fi
                
                nohup /opt/shuffle/monitor-db-permissions.sh > /var/log/shuffle-db-monitor.log 2>&1 &
                echo "Shuffle initialization complete!"
              - TotalNodes: !Ref NodeCount
                AwsRegion: !Ref AWS::Region
                DeploymentName: !Ref DeploymentName

  # ==================== Auto Scaling Group ====================

  ShuffleASG:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: !Sub '${DeploymentName}-asg'
      VPCZoneIdentifier:
        - !Ref ShuffleSubnet
      LaunchTemplate:
        LaunchTemplateId: !Ref ShuffleLaunchTemplate
        Version: !GetAtt ShuffleLaunchTemplate.LatestVersionNumber
      MinSize: !Ref NodeCount
      MaxSize: !Ref NodeCount
      DesiredCapacity: !Ref NodeCount
      HealthCheckType: EC2
      HealthCheckGracePeriod: 600
      Tags:
        - Key: Name
          Value: !Sub '${DeploymentName}-node'
          PropagateAtLaunch: true
        - Key: Environment
          Value: !Ref Environment
          PropagateAtLaunch: true

  # ==================== CloudWatch Log Group ====================

  ShuffleLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/shuffle/${DeploymentName}'
      RetentionInDays: 7

Outputs:
  VPCId:
    Description: VPC ID
    Value: !Ref ShuffleVPC
    Export:
      Name: !Sub '${DeploymentName}-vpc-id'

  SubnetId:
    Description: Subnet ID
    Value: !Ref ShuffleSubnet
    Export:
      Name: !Sub '${DeploymentName}-subnet-id'

  SecurityGroupInternal:
    Description: Internal Security Group ID
    Value: !Ref ShuffleInternalSG
    Export:
      Name: !Sub '${DeploymentName}-internal-sg-id'

  SecurityGroupExternal:
    Description: External Security Group ID
    Value: !Ref ShuffleExternalSG
    Export:
      Name: !Sub '${DeploymentName}-external-sg-id'

  AutoScalingGroupName:
    Description: Auto Scaling Group Name
    Value: !Ref ShuffleASG

  DeploymentName:
    Description: Deployment Name
    Value: !Ref DeploymentName

  ShuffleFrontendURL:
    Description: URL to access Shuffle Frontend (replace INSTANCE_IP with actual instance public IP)
    Value: !Sub 'http://INSTANCE_IP:3001'

  PostDeploymentInstructions:
    Description: Instructions after deployment
    Value: !Join
      - ''
      - - |
          =================================================================
          Shuffle Deployment In Progress!
          =================================================================
          
          The Shuffle cluster is being deployed with 
        - !Ref NodeCount
        - !Sub |2
           node(s).
          
          To access Shuffle:
          1. Wait 5-10 minutes for instances to initialize
          2. Get the public IP of any instance from EC2 console
          3. Access: http://INSTANCE_IP:3001
          
          To manage the cluster:
          - View running services: docker stack services shuffle
          - View logs: docker service logs shuffle_<service-name>
          - Check swarm status: docker node ls
          
          Security:
          - Only port 3001 is exposed externally
          - All internal services use VPC-internal communication
          
          =================================================================
