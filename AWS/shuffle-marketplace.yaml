AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Shuffle SOAR Platform - Docker Swarm Cluster Deployment
  Deploys a highly available Shuffle cluster on AWS using EC2 instances with Docker Swarm.
  Includes: VPC, Security Groups, EC2 Auto Scaling, NFS shared storage, OpenSearch, and load balancing.
  
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: "Deployment Configuration"
        Parameters:
          - DeploymentName
          - Environment
      - Label:
          default: "Instance Configuration"
        Parameters:
          - InstanceType
          - NodeCount
          - VolumeSize
          - VolumeType
      - Label:
          default: "Network Configuration"
        Parameters:
          - VpcCIDR
          - SubnetCIDR
          - ExternalAccessCIDRs
          - EnableSSH
          - SSHKeyName
          - SSHAccessCIDRs
    ParameterLabels:
      DeploymentName:
        default: "Deployment Name"
      Environment:
        default: "Environment"
      NodeCount:
        default: "Number of Nodes"
      InstanceType:
        default: "EC2 Instance Type"
      VolumeSize:
        default: "EBS Volume Size (GB)"
      VolumeType:
        default: "EBS Volume Type"
      VpcCIDR:
        default: "VPC CIDR Block"
      SubnetCIDR:
        default: "Subnet CIDR Block"
      ExternalAccessCIDRs:
        default: "External Access CIDRs"
      EnableSSH:
        default: "Enable SSH Access"
      SSHKeyName:
        default: "SSH Key Pair Name"
      SSHAccessCIDRs:
        default: "SSH Access CIDRs"

Parameters:
  DeploymentName:
    Type: String
    Description: >-
      Unique name for this Shuffle deployment, used to name all associated AWS resources
      (VPC, subnets, security groups, ASG, etc.). Use lowercase letters, numbers, and
      hyphens only (e.g., shuffle-prod, shuffle-dev-01).
    Default: shuffle-cluster
    MinLength: 3
    MaxLength: 32
    AllowedPattern: ^[a-z][a-z0-9-]*[a-z0-9]$
    ConstraintDescription: >-
      Must be 3-32 characters long, begin with a lowercase letter, end with a letter or
      number, and contain only lowercase letters, numbers, and hyphens.

  Environment:
    Type: String
    Description: >-
      Deployment environment type, used for resource tagging and operational context.
      Choose 'production' for live workloads, 'staging' for pre-production testing,
      or 'dev' for development and experimentation.
    Default: production
    AllowedValues:
      - dev
      - staging
      - production

  NodeCount:
    Type: Number
    Description: >-
      Total number of EC2 instances in the Docker Swarm cluster. Use 1 for single-node
      evaluation, 3 for high-availability production, or up to 10 for large-scale
      deployments. All nodes participate as Swarm managers.
    Default: 1
    MinValue: 1
    MaxValue: 10
    ConstraintDescription: Must be a whole number between 1 and 10.

  InstanceType:
    Type: String
    Description: >-
      EC2 instance type for each Shuffle node. Minimum recommended: t3.large (2 vCPUs,
      8 GB RAM). For production workloads with heavy automation, use t3.xlarge or larger.
      m5/m6i families provide consistent baseline performance for sustained workloads.
    Default: t3.large
    AllowedValues:
      - t3.large      # 2 vCPUs, 8GB RAM
      - t3.xlarge     # 4 vCPUs, 16GB RAM
      - t3.2xlarge    # 8 vCPUs, 32GB RAM
      - m5.large      # 2 vCPUs, 8GB RAM
      - m5.xlarge     # 4 vCPUs, 16GB RAM
      - m5.2xlarge    # 8 vCPUs, 32GB RAM
      - m6i.large     # 2 vCPUs, 8GB RAM
      - m6i.xlarge    # 4 vCPUs, 16GB RAM
      - m6i.2xlarge   # 8 vCPUs, 32GB RAM

  VolumeSize:
    Type: Number
    Description: >-
      Size of the EBS root volume in GB for each node. Stores Docker images, OpenSearch
      data, and Shuffle application data. Minimum 120 GB required; increase for
      environments with large workflow histories or many installed apps.
    Default: 120
    MinValue: 120
    MaxValue: 1000
    ConstraintDescription: Must be a whole number between 120 and 1000 GB.

  VolumeType:
    Type: String
    Description: >-
      EBS volume type for root volumes. gp3 (recommended) provides a 3000 IOPS baseline
      at lower cost than gp2. Use io1/io2 only for workloads requiring guaranteed
      high IOPS beyond the gp3 baseline.
    Default: gp3
    AllowedValues:
      - gp3  # General Purpose SSD (recommended)
      - gp2  # General Purpose SSD
      - io1  # Provisioned IOPS SSD
      - io2  # Provisioned IOPS SSD

  AmazonLinux2023AMI:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Description: Amazon Linux 2023 AMI (dynamically resolved from SSM Parameter Store)
    Default: /aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-x86_64

  VpcCIDR:
    Type: String
    Description: >-
      CIDR block for the new VPC. A /16 block provides maximum flexibility for subnets.
      Ensure this range does not overlap with existing VPCs if you plan VPC peering.
    Default: 10.224.0.0/16
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: Must be a valid IPv4 CIDR block (e.g., 10.224.0.0/16).

  SubnetCIDR:
    Type: String
    Description: >-
      CIDR block for the primary subnet. Must fall within the VPC CIDR range. A /24 block
      provides 254 usable IP addresses, sufficient for most Shuffle deployments.
    Default: 10.224.1.0/24
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: Must be a valid IPv4 CIDR block within the VPC range (e.g., 10.224.1.0/24).

  ExternalAccessCIDRs:
    Type: CommaDelimitedList
    Description: >-
      Comma-separated CIDR blocks allowed to access the Shuffle UI on port 3001.
      Do NOT use 0.0.0.0/0 in production. Restrict to your organization's IP
      ranges (e.g., 203.0.113.0/24,198.51.100.0/24).

  EnableSSH:
    Type: String
    Description: >-
      Enable SSH access (port 22) to cluster instances for troubleshooting. Set to
      'false' to harden network security. Requires a valid SSHKeyName when enabled.
      AWS Systems Manager Session Manager is available regardless of this setting.
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'

  SSHAccessCIDRs:
    Type: CommaDelimitedList
    Description: >-
      Comma-separated CIDR blocks allowed SSH access when EnableSSH is 'true'.
      Do NOT use 0.0.0.0/0 in production. Restrict to trusted admin IP ranges
      (e.g., 10.0.0.0/8 for internal networks or specific public IPs).

  SSHKeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: >-
      Name of an existing EC2 Key Pair for SSH access. Required when EnableSSH is 'true'.
      The key pair must already exist in the same AWS region as this deployment.
    ConstraintDescription: Must be the name of an existing EC2 Key Pair in your account.


Conditions:
  EnableSSHAccess: !Equals [!Ref EnableSSH, 'true']
  MultiNode: !Not [!Equals [!Ref NodeCount, 1]]

Resources:
  # ==================== VPC and Networking ====================
  
  ShuffleVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCIDR
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${DeploymentName}-vpc'
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: Shuffle

  ShuffleInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${DeploymentName}-igw'

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref ShuffleVPC
      InternetGatewayId: !Ref ShuffleInternetGateway

  ShuffleSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ShuffleVPC
      CidrBlock: !Select [0, !Cidr [!Ref VpcCIDR, 4, 8]]
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select 
        - 0
        - !GetAZs ''
      Tags:
        - Key: Name
          Value: !Sub '${DeploymentName}-subnet-az1'
        - Key: AZ
          Value: !Select [0, !GetAZs '']

  ShuffleSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ShuffleVPC
      CidrBlock: !Select [1, !Cidr [!Ref VpcCIDR, 4, 8]]
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select 
        - 1
        - !GetAZs ''
      Tags:
        - Key: Name
          Value: !Sub '${DeploymentName}-subnet-az2'
        - Key: AZ
          Value: !Select [1, !GetAZs '']

  ShuffleSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ShuffleVPC
      CidrBlock: !Select [2, !Cidr [!Ref VpcCIDR, 4, 8]]
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select 
        - 2
        - !GetAZs ''
      Tags:
        - Key: Name
          Value: !Sub '${DeploymentName}-subnet-az3'
        - Key: AZ
          Value: !Select [2, !GetAZs '']

  ShuffleRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref ShuffleVPC
      Tags:
        - Key: Name
          Value: !Sub '${DeploymentName}-rt'

  ShuffleRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref ShuffleRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref ShuffleInternetGateway

  SubnetRouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref ShuffleSubnet1
      RouteTableId: !Ref ShuffleRouteTable

  SubnetRouteTableAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref ShuffleSubnet2
      RouteTableId: !Ref ShuffleRouteTable

  SubnetRouteTableAssociation3:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref ShuffleSubnet3
      RouteTableId: !Ref ShuffleRouteTable

  # ==================== Security Groups ====================

  ShuffleInternalSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${DeploymentName}-internal-sg'
      GroupDescription: Internal communication for Shuffle Docker Swarm cluster
      VpcId: !Ref ShuffleVPC
      Tags:
        - Key: Name
          Value: !Sub '${DeploymentName}-internal-sg'

  # Docker Swarm Internal Rules
  SwarmTCPIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: tcp
      FromPort: 2376
      ToPort: 2377
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: Docker Swarm management

  SwarmTCPIngress2:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: tcp
      FromPort: 7946
      ToPort: 7946
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: Docker Swarm node communication

  SwarmUDPIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: udp
      FromPort: 7946
      ToPort: 7946
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: Docker Swarm node communication

  SwarmUDPIngress2:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: udp
      FromPort: 4789
      ToPort: 4789
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: Docker overlay network

  # NFS for shared storage
  NFSTCPIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: tcp
      FromPort: 2049
      ToPort: 2049
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: NFS

  NFSTCPIngress2:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: tcp
      FromPort: 111
      ToPort: 111
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: NFS portmapper

  NFSTCPIngress3:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: tcp
      FromPort: 32768
      ToPort: 65535
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: NFS auxiliary services (mountd, statd, lockd)

  NFSUDPIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: udp
      FromPort: 2049
      ToPort: 2049
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: NFS

  NFSUDPIngress2:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: udp
      FromPort: 111
      ToPort: 111
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: NFS portmapper

  NFSUDPIngress3:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: udp
      FromPort: 32768
      ToPort: 65535
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: NFS auxiliary services (mountd, statd, lockd)

  # Internal Shuffle services
  OpenSearchIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: tcp
      FromPort: 9200
      ToPort: 9300
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: OpenSearch

  BackendIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: tcp
      FromPort: 5001
      ToPort: 5002
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: Shuffle backend

  WorkerIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: tcp
      FromPort: 33333
      ToPort: 33336
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: Shuffle workers

  MemcachedIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleInternalSG
      IpProtocol: tcp
      FromPort: 11211
      ToPort: 11211
      SourceSecurityGroupId: !Ref ShuffleInternalSG
      Description: Memcached

  ShuffleExternalSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${DeploymentName}-external-sg'
      GroupDescription: External access to Shuffle UI
      VpcId: !Ref ShuffleVPC
      Tags:
        - Key: Name
          Value: !Sub '${DeploymentName}-external-sg'

  # External access to Shuffle UI (port 3001)
  ExternalHTTPIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref ShuffleExternalSG
      IpProtocol: tcp
      FromPort: 3001
      ToPort: 3001
      CidrIp: !Select [0, !Ref ExternalAccessCIDRs]
      Description: Shuffle UI access

  # SSH Security Group (conditional)
  ShuffleSSHSG:
    Type: AWS::EC2::SecurityGroup
    Condition: EnableSSHAccess
    Properties:
      GroupName: !Sub '${DeploymentName}-ssh-sg'
      GroupDescription: SSH access to Shuffle nodes
      VpcId: !Ref ShuffleVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Select [0, !Ref SSHAccessCIDRs]
          Description: SSH access
      Tags:
        - Key: Name
          Value: !Sub '${DeploymentName}-ssh-sg'

  # ==================== EC2 Placement Group ====================

  ShufflePlacementGroup:
    Type: AWS::EC2::PlacementGroup
    Properties:
      GroupName: !Sub '${DeploymentName}-placement-group'
      Strategy: spread
      Tags:
        - Key: Name
          Value: !Sub '${DeploymentName}-placement-group'
        - Key: Application
          Value: Shuffle

  # ==================== IAM Role ====================

  ShuffleInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${DeploymentName}-instance-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: ShuffleEC2Permissions
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ec2:DescribeInstances
                  - ec2:DescribeTags
                  - ec2:DescribeNetworkInterfaces
                  - autoscaling:DescribeAutoScalingGroups
                  - autoscaling:DescribeAutoScalingInstances
                Resource: '*'
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogStreams
                Resource: !Sub 'arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/shuffle/*'
              - Effect: Allow
                Action:
                  - ssm:PutParameter
                  - ssm:GetParameter
                  - ssm:DeleteParameter
                Resource: !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${DeploymentName}/*'
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource:
                  - 'arn:aws:s3:::shuffler/config/*'
              - Effect: Allow
                Action:
                  - s3:ListBucket
                Resource:
                  - 'arn:aws:s3:::shuffler'
                Condition:
                  StringLike:
                    s3:prefix:
                      - 'config/*'
      Tags:
        - Key: Name
          Value: !Sub '${DeploymentName}-instance-role'

  ShuffleInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub '${DeploymentName}-instance-profile'
      Roles:
        - !Ref ShuffleInstanceRole

  ShuffleLaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: !Sub '${DeploymentName}-launch-template'
      LaunchTemplateData:
        # Use dynamic SSM parameter for Amazon Linux 2023 AMI (region-specific)
        ImageId: !Ref AmazonLinux2023AMI
        InstanceType: !Ref InstanceType
        KeyName: !If [EnableSSHAccess, !Ref SSHKeyName, !Ref 'AWS::NoValue']
        IamInstanceProfile:
          Arn: !GetAtt ShuffleInstanceProfile.Arn
        BlockDeviceMappings:
          - DeviceName: /dev/sda1
            Ebs:
              VolumeSize: !Ref VolumeSize
              VolumeType: !Ref VolumeType
              DeleteOnTermination: true
              Encrypted: true
        Placement:
          GroupName: !Ref ShufflePlacementGroup
        NetworkInterfaces:
          - DeviceIndex: 0
            AssociatePublicIpAddress: true
            Groups: !If
              - EnableSSHAccess
              - - !Ref ShuffleInternalSG
                - !Ref ShuffleExternalSG
                - !Ref ShuffleSSHSG
              - - !Ref ShuffleInternalSG
                - !Ref ShuffleExternalSG
        TagSpecifications:
          - ResourceType: instance
            Tags:
              - Key: Name
                Value: !Sub '${DeploymentName}-node'
              - Key: Environment
                Value: !Ref Environment
              - Key: Application
                Value: Shuffle
              - Key: DeploymentName
                Value: !Ref DeploymentName
        UserData:
          Fn::Base64:
            Fn::Sub:
              - |
                #!/bin/bash
                set -euo pipefail
                exec > >(tee /var/log/shuffle-startup.log) 2>&1
                
                echo "Starting Shuffle node initialization on Amazon Linux 2023..."
                
                # Configuration from CloudFormation
                export DEPLOYMENT_NAME="${DeploymentName}"
                export TOTAL_NODES="${TotalNodes}"
                export AWS_REGION="${AwsRegion}"
                
                # Get EC2 instance metadata
                get_instance_metadata() {
                  local path="$1"
                  TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600" 2>/dev/null || echo "")
                  if [[ -n "$TOKEN" ]]; then
                    curl -H "X-aws-ec2-metadata-token: $TOKEN" "http://169.254.169.254/latest/meta-data/$path" 2>/dev/null || echo ""
                  else
                    curl "http://169.254.169.254/latest/meta-data/$path" 2>/dev/null || echo ""
                  fi
                }
                
                INSTANCE_ID=$(get_instance_metadata "instance-id")
                LOCAL_IP=$(get_instance_metadata "local-ipv4")
                
                echo "Instance ID: $INSTANCE_ID, IP: $LOCAL_IP"
                
                # Update system packages (Amazon Linux 2023 uses dnf)
                echo "Updating system packages..."
                dnf update -y
                
                # Install dependencies for Amazon Linux 2023
                echo "Installing dependencies..."
                # Use --allowerasing to handle package conflicts
                dnf install -y --allowerasing ca-certificates curl nfs-utils jq nmap-ncat aws-cli
                
                # Install Docker CE on Amazon Linux 2023
                echo "Installing Docker..."
                if ! command -v docker &> /dev/null; then
                  dnf install -y docker
                  systemctl enable docker
                  systemctl start docker
                  echo "Docker installed successfully"
                fi
                
                # Install Docker Compose (optional, as Docker Swarm is used for orchestration)
                # Try to install docker-compose package; skip if unavailable
                if ! docker compose version &> /dev/null; then
                  dnf install -y docker-compose 2>/dev/null || echo "docker-compose not available in repos; proceeding with Docker Swarm"
                fi
                
                # Add ec2-user to docker group for Docker socket access
                usermod -aG docker ec2-user
                
                # Setup directories
                mkdir -p /opt/shuffle/shuffle-database
                chown 1000:1000 /opt/shuffle/shuffle-database
                chmod 755 /opt/shuffle/shuffle-database
                
                # Determine if primary node
                ASG_NAME="${DeploymentName}-asg"
                IS_PRIMARY="false"
                for i in {1..30}; do
                  INSTANCES=$(aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names "$ASG_NAME" --region "$AWS_REGION" --query 'AutoScalingGroups[0].Instances[?HealthStatus==`Healthy`].InstanceId' --output text 2>/dev/null | tr '\t' '\n' | sort || echo "")
                  if [[ -n "$INSTANCES" ]]; then
                    FIRST_INSTANCE=$(echo "$INSTANCES" | head -n1)
                    [[ "$INSTANCE_ID" == "$FIRST_INSTANCE" ]] && IS_PRIMARY="true"
                    break
                  fi
                  sleep 10
                done
                [[ "$TOTAL_NODES" == "1" ]] && IS_PRIMARY="true"
                
                mkdir -p /opt/shuffle
                cd /opt/shuffle
                
                # Download config files from S3 bucket
                echo "Downloading configuration files from S3..."
                
                aws s3 cp s3://shuffler/config/swarm.yaml swarm.yaml --region "$AWS_REGION"
                aws s3 cp s3://shuffler/config/deploy.sh deploy.sh --region "$AWS_REGION"
                aws s3 cp s3://shuffler/config/setup-nfs-server.sh setup-nfs-server.sh --region "$AWS_REGION"
                aws s3 cp s3://shuffler/config/nginx-main.conf nginx-main.conf --region "$AWS_REGION"
                aws s3 cp s3://shuffler/config/.env .env --region "$AWS_REGION"
                aws s3 cp s3://shuffler/config/monitor-db-permissions.sh monitor-db-permissions.sh --region "$AWS_REGION"
                
                # Convert Windows line endings (CRLF) to Unix line endings (LF)
                echo "Converting line endings to Unix format..."
                for file in deploy.sh setup-nfs-server.sh monitor-db-permissions.sh; do
                  sed -i 's/\r$//' "$file" 2>/dev/null || true
                done
                
                chmod +x deploy.sh setup-nfs-server.sh monitor-db-permissions.sh
                
                # Make downloaded scripts compatible with the instance package manager
                if command -v dnf &> /dev/null; then
                  echo "Detected DNF-based distro; adjusting downloaded scripts for dnf"
                  if [ -f setup-nfs-server.sh ]; then
                    sed -i 's/apt-get/dnf/g' setup-nfs-server.sh 2>/dev/null || true
                    sed -i 's/apt /dnf /g' setup-nfs-server.sh 2>/dev/null || true
                    sed -i 's/nfs-kernel-server/nfs-utils/g' setup-nfs-server.sh 2>/dev/null || true
                    sed -i 's/nfs-common/nfs-utils/g' setup-nfs-server.sh 2>/dev/null || true
                  fi

                  # Add a lightweight apt-get shim so any remaining apt-get calls succeed
                  if [ ! -x /usr/local/bin/apt-get ]; then
                    echo '#!/bin/bash' > /usr/local/bin/apt-get || true
                    echo "# Minimal apt-get shim: translate 'apt-get install' to 'dnf install -y'" >> /usr/local/bin/apt-get || true
                    echo 'if [ "$1" = "install" ]; then' >> /usr/local/bin/apt-get || true
                    echo '  shift' >> /usr/local/bin/apt-get || true
                    echo '  exec dnf install -y "$@"' >> /usr/local/bin/apt-get || true
                    echo 'fi' >> /usr/local/bin/apt-get || true
                    echo 'echo "apt-get shim: only \"install\" supported" >&2' >> /usr/local/bin/apt-get || true
                    echo 'exit 1' >> /usr/local/bin/apt-get || true
                    chmod +x /usr/local/bin/apt-get || true
                  fi
                fi

                echo "Configuration files downloaded successfully"
                
                if [[ "$IS_PRIMARY" == "true" ]]; then
                  echo "Initializing Docker Swarm as primary node..."
                  docker swarm init --advertise-addr $LOCAL_IP
                  MANAGER_TOKEN=$(docker swarm join-token manager -q)
                  aws ssm put-parameter --name "/$DEPLOYMENT_NAME/swarm-manager-token" --value "$MANAGER_TOKEN" --type "SecureString" --region "$AWS_REGION" --overwrite || true
                  aws ssm put-parameter --name "/$DEPLOYMENT_NAME/primary-manager-ip" --value "$LOCAL_IP" --type "String" --region "$AWS_REGION" --overwrite || true
                  
                  # Wait for all nodes to join
                  for i in {1..300}; do
                    CURRENT_COUNT=$(docker node ls --format "{{.ID}}" | wc -l)
                    [[ "$CURRENT_COUNT" -eq "$TOTAL_NODES" ]] && break
                    sleep 10
                  done
                  sleep 30
                  # Ensure NFS server is configured on primary for Amazon Linux
                  if command -v dnf &> /dev/null; then
                    echo "Setting up NFS server for Amazon Linux on primary node"
                    mkdir -p /opt/shuffle/shuffle-database
                    chown nfsnobody:nfsnobody /opt/shuffle/shuffle-database 2>/dev/null || true
                    chmod 755 /opt/shuffle/shuffle-database
                    if ! grep -q "/opt/shuffle/shuffle-database" /etc/exports 2>/dev/null; then
                      echo "/opt/shuffle/shuffle-database *(rw,sync,no_subtree_check,no_root_squash)" >> /etc/exports
                    fi
                    systemctl enable --now nfs-server 2>/dev/null || true
                    exportfs -ra 2>/dev/null || true
                  fi
                  bash deploy.sh
                else
                  echo "Joining Docker Swarm as secondary node..."
                  # Secondary node - join swarm
                  for i in {1..60}; do
                    PRIMARY_IP=$(aws ssm get-parameter --name "/$DEPLOYMENT_NAME/primary-manager-ip" --region "$AWS_REGION" --query 'Parameter.Value' --output text 2>/dev/null || echo "")
                    if [[ -n "$PRIMARY_IP" ]] && nc -z -w5 $PRIMARY_IP 2377 2>/dev/null; then
                      MANAGER_TOKEN=$(aws ssm get-parameter --name "/$DEPLOYMENT_NAME/swarm-manager-token" --region "$AWS_REGION" --query 'Parameter.Value' --output text --with-decryption 2>/dev/null || echo "")
                      if [[ -n "$MANAGER_TOKEN" ]]; then
                        docker swarm join --token "$MANAGER_TOKEN" "$PRIMARY_IP:2377" && break
                      fi
                    fi
                    sleep 10
                  done
                fi
                
                nohup /opt/shuffle/monitor-db-permissions.sh > /var/log/shuffle-db-monitor.log 2>&1 &
                echo "Shuffle initialization complete!"
              - TotalNodes: !Ref NodeCount
                AwsRegion: !Ref AWS::Region
                DeploymentName: !Ref DeploymentName

  # ==================== Auto Scaling Group ====================

  ShuffleASG:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: !Sub '${DeploymentName}-asg'
      VPCZoneIdentifier:
        - !Ref ShuffleSubnet1
        - !Ref ShuffleSubnet2
        - !Ref ShuffleSubnet3
      LaunchTemplate:
        LaunchTemplateId: !Ref ShuffleLaunchTemplate
        Version: !GetAtt ShuffleLaunchTemplate.LatestVersionNumber
      MinSize: !Ref NodeCount
      MaxSize: !Ref NodeCount
      DesiredCapacity: !Ref NodeCount
      HealthCheckType: EC2
      HealthCheckGracePeriod: 600
      Tags:
        - Key: Name
          Value: !Sub '${DeploymentName}-node'
          PropagateAtLaunch: true
        - Key: Environment
          Value: !Ref Environment
          PropagateAtLaunch: true

  # ==================== CloudWatch Log Group ====================

  ShuffleLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/shuffle/${DeploymentName}'
      RetentionInDays: 7

Outputs:
  VPCId:
    Description: VPC ID
    Value: !Ref ShuffleVPC
    Export:
      Name: !Sub '${DeploymentName}-vpc-id'

  SubnetId1:
    Description: Subnet 1 ID (AZ1)
    Value: !Ref ShuffleSubnet1
    Export:
      Name: !Sub '${DeploymentName}-subnet-1-id'

  SubnetId2:
    Description: Subnet 2 ID (AZ2)
    Value: !Ref ShuffleSubnet2
    Export:
      Name: !Sub '${DeploymentName}-subnet-2-id'

  SubnetId3:
    Description: Subnet 3 ID (AZ3)
    Value: !Ref ShuffleSubnet3
    Export:
      Name: !Sub '${DeploymentName}-subnet-3-id'

  SecurityGroupInternal:
    Description: Internal Security Group ID
    Value: !Ref ShuffleInternalSG
    Export:
      Name: !Sub '${DeploymentName}-internal-sg-id'

  SecurityGroupExternal:
    Description: External Security Group ID
    Value: !Ref ShuffleExternalSG
    Export:
      Name: !Sub '${DeploymentName}-external-sg-id'

  AutoScalingGroupName:
    Description: Auto Scaling Group Name
    Value: !Ref ShuffleASG

  PlacementGroupName:
    Description: EC2 Placement Group Name (Spread strategy for high-availability)
    Value: !Ref ShufflePlacementGroup
    Export:
      Name: !Sub '${DeploymentName}-placement-group'

  DeploymentName:
    Description: Deployment Name
    Value: !Ref DeploymentName

  ShuffleFrontendURL:
    Description: URL to access Shuffle Frontend (replace INSTANCE_IP with actual instance public IP)
    Value: !Sub 'http://INSTANCE_IP:3001'

  PostDeploymentInstructions:
    Description: Instructions after deployment
    Value: !Join
      - ''
      - - |
          =================================================================
          Shuffle Deployment In Progress!
          =================================================================
          
          The Shuffle cluster is being deployed with 
        - !Ref NodeCount
        - !Sub |2
           node(s).
          
          To access Shuffle:
          1. Wait 5-10 minutes for instances to initialize
          2. Get the public IP of any instance from EC2 console
          3. Access: http://INSTANCE_IP:3001
          
          To manage the cluster:
          - View running services: docker stack services shuffle
          - View logs: docker service logs shuffle_<service-name>
          - Check swarm status: docker node ls
          
          Security:
          - Only port 3001 is exposed externally
          - All internal services use VPC-internal communication
          
          =================================================================
